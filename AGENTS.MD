
agent.md

1. Role and Objectives

This repository concerns the development, calibration, and validation of an HC2-based inferential reliability metric for linear regression. Any automated agent acting on this project is expected to:
	•	Maintain a codebase and document structure that are academically defensible.
	•	Preserve reproducibility and traceability of all analytical steps.
	•	Avoid unnecessary proliferation of files, especially redundant or automatically generated markdown summaries.

The intended audience is methodological reviewers, thesis supervisors, and quantitative researchers. All contributions must reflect this level of discourse.

⸻

2. Core Principles
	1.	Minimal, stable documentation set
The repository must contain:
	•	Exactly one README.md
	•	Exactly one CHANGELOG.md
	•	Exactly one INDEX.md (or a single, clearly identified index file such as docs/index.md)
The agent must not create additional top-level markdown “meta” files such as:
	•	summary_*.md
	•	notes_*.md
	•	*_log.md
	•	Verification / audit / run-by-run reports (VERIFICATION_SUMMARY.*, audit_*.md, check_results_*.txt, etc.)
When new documentation is needed, it must be integrated into:
	•	README.md (project-level overview, usage)
	•	INDEX.md (structural map)
	•	CHANGELOG.md (evolution record)
or into inline comments in code where appropriate. No other permanent text artefacts should be introduced unless explicitly instructed.
	2.	Academic tone and register
	•	Use precise, technical language suitable for a methods appendix or technical report.
	•	Do not write for beginners or in a tutorial style.
	•	Avoid conversational framing (“we explain this for you”, “this is simplified”).
	•	Justifications should be written as if addressing an anonymous methods reviewer or future researcher.
	3.	Refactor, do not duplicate
	•	Prefer refactoring existing scripts/notebooks over creating new near-duplicates.
	•	Implement new functionality within the existing module structure, e.g. add to R/20_metrics.R instead of creating R/20_metrics_v2.R.
	•	If behaviour changes, update the canonical function in-place, update all call sites, and record the change in CHANGELOG.md.

⸻

3. Directory and File Conventions

The repository is assumed to follow this general structure:
	•	README.md – High-level project description and usage.
	•	CHANGELOG.md – Chronological record of substantive changes.
	•	INDEX.md – Structural overview of notebooks, scripts, and key results.
	•	R/ – R support files (configuration, DGPs, estimators, metrics, orchestration).
	•	notebooks/ – Jupyter or R notebooks providing narrative analyses.
	•	results/ – Serialized results (.rds, .csv, figures) generated by the pipeline.
	•	agent.md – This control file describing agent behaviour and constraints.

No additional top-level documentation formats or directories should be introduced without explicit instruction.

3.1 README.md

The agent may:
	•	Update the project description, system requirements, and “quick start” instructions as the pipeline evolves.
	•	Summarize the main analytical stages (null calibration, HC2 selection, heteroskedastic validation, invariance analysis, lookup table construction).

The agent must not:
	•	Use README.md as a log, scratchpad, or running commentary.
	•	Add informal, pedagogical, or conversational text.

3.2 CHANGELOG.md

The agent should:
	•	Append entries in a consistent chronological order (respect existing convention).
	•	Record substantive changes, especially:
	•	Modifications to DGPs or simulation logic.
	•	Changes to metric definitions or parameterization.
	•	Changes to file structure, configuration, or reproducibility.

The agent must not:
	•	Split the changelog into multiple files.
	•	Log purely cosmetic edits unless they affect interpretation or reproducibility.

3.3 INDEX.md

INDEX.md (or the designated index file) serves as a structural map of the repository:
	•	List all key notebooks, scripts, and stable result artefacts.
	•	For each, specify:
	•	Purpose (e.g. “Null calibration of HC estimators; inferential score behaviour under homoskedasticity.”)
	•	Inputs and outputs (e.g. results/scaling_results.rds, results/universal_lookup_table.rds).

The agent may:
	•	Add entries when new components become a stable part of the pipeline.
	•	Update descriptions when the role of a file or notebook changes.

The agent must not:
	•	Create additional index-like top-level files (INDEX_v2.md, notebook_index.md, etc.) unless explicitly requested.

⸻

4. Notebooks and Scripts

4.1 Notebooks

There should be a small, canonical set of notebooks, for example:
	•	01_null_calibration_HC1_HC2_HC3.Rmd / .ipynb
Null behaviour of inferential scores and HC comparison.
	•	02_HC2_validation_and_lookup.Rmd / .ipynb
Heteroskedastic simulations, coverage mapping, invariance analysis, and final lookup table construction.

The agent should:
	•	Keep notebooks synchronized with refactored R functions.
	•	Treat notebooks as narrative layers: heavy computation should be delegated to functions in R/ scripts.
	•	Prefer calls to existing helpers over re-implementing logic inline.

The agent must not:
	•	Create near-duplicate notebooks (e.g. 01_null_calibration_final.ipynb, 01_null_calibration_new.ipynb) without explicit instruction.
	•	Embed large blocks of function definitions inside notebooks that belong in R/ support files.

4.2 R Support Files

Expected R module structure (illustrative, but canonical):
	•	R/00_config.R – Global options, package loading, seeds, file paths, parameter grids.
	•	R/10_dgp_and_fits.R – Data-generating processes; OLS and HC estimation engines.
	•	R/20_metrics.R – Metric definitions: classic SEs, HC SEs, inferential and reliability scores.
	•	R/30_null_calibration.R – Null calibration routines and scaling analysis.
	•	R/40_hetero_sims.R – Heteroskedastic simulation grid and aggregation.
	•	R/50_invariance_and_lookup.R – Invariance analysis and universal lookup table construction.
	•	R/60_tables_and_plots.R – Presentation utilities (tables, plots, export helpers).

The agent should:
	•	Place reusable logic in these scripts rather than duplicating it in notebooks.
	•	Maintain function interfaces when possible; if an interface changes:
	•	Update all dependent code (other R/ files and notebooks).
	•	Record the change in CHANGELOG.md.

The agent must not:
	•	Create numbered variants of existing modules (R/20_metrics_v2.R, R/40_hetero_sims_old.R) unless part of a clearly documented migration.
	•	Introduce hidden state or side effects (e.g. implicit working-directory changes, silent global option tweaks) that undermine reproducibility.

⸻

5. Metric Definitions and Notation

The following naming conventions and definitions are canonical and must be used consistently across the codebase, notebooks, and documentation:
	•	Coefficient of interest
	•	Name in models: "x"
	•	Index in simple regression: 2L (intercept is index 1).
	•	Standard errors
	•	se_classic – Homoskedastic OLS standard error for the coefficient of interest.
	•	se_robust – HC standard error (by default HC2) for the same coefficient.
	•	Inferential Score
	•	Symbol: S_{\mathrm{Inf}}
	•	Code: sr_inf
	•	Definition:
S_{\mathrm{Inf}} = \frac{\text{SE}_{\text{robust}}}{\text{SE}_{\text{classic}}} - 1
	•	Scaled Inferential Score
	•	Symbol: S_{\mathrm{Inf}}^{\ast}
	•	Code: sr_inf_adj
	•	Definition:
S_{\mathrm{Inf}}^{\ast} = \sqrt{N} \cdot S_{\mathrm{Inf}}
	•	Under the homoskedastic null with HC2, this behaves like a standard normal test statistic.
	•	Raw Ratio
	•	Code: sr_ratio
	•	Definition:
\text{sr\_ratio} = \frac{\text{SE}_{\text{classic}}}{\text{SE}_{\text{robust}}}
	•	Reliability Score (Adjusted Ratio)
	•	Preferred label in text: Reliability Score
	•	Symbol: S_{\mathrm{Rel}}
	•	Code: sr_ratio_adj
	•	Definition (HC2-based finite-sample bias correction):
S_{\mathrm{Rel}} = \text{sr\_ratio} - \frac{2}{3\sqrt{N}}
	•	This score is calibrated against empirical coverage loss under controlled heteroskedasticity and is intended to be approximately N-invariant.

The agent must:
	•	Use these names and formulas exactly.
	•	Avoid introducing alternative symbols such as S_Adj, S_Rel2, or functionally equivalent but differently named scores.

If any of these definitions are changed, this constitutes a breaking change and requires:
	•	A consistent update across all code and notebooks.
	•	A clear entry in CHANGELOG.md describing the new definition and the rationale.

⸻

6. Logging, Output, and File Creation
	1.	No automatic markdown/log proliferation
The agent must not emit run-specific or ephemeral documentation files such as:
	•	run_YYYYMMDD.md
	•	analysis_summary_*.md
	•	verification_*.txt
Stable results should be written to:
	•	.rds or .csv files in results/
	•	Figures (e.g. .png, .pdf) in an agreed directory (e.g. results/ or figures/)
	2.	Stable artefact names
Use stable, descriptive filenames such as:
	•	results/scores_long.rds
	•	results/q95_summary.rds
	•	results/scaling_results.rds
	•	results/hetero_sim_results.rds
	•	results/hetero_aggregated.rds
	•	results/coverage_adjusted_by_N.rds
	•	results/universal_lookup_table.rds
Avoid versioned suffixes like _final, _new, _latest unless part of a deliberate archival policy that is explicitly documented.
	3.	Reproducibility and seeds
	•	The global seed is set centrally in R/00_config.R, e.g.

set.seed(2024)


	•	Parallel execution must derive worker seeds from this global seed using:
	•	furrr::future_map(..., .options = furrr::furrr_options(seed = TRUE))
	•	Notebooks and scripts should not override the global seed in a way that changes the main analytical results. Local calls to set.seed() are only acceptable for:
	•	Minor illustrative examples that do not affect the primary pipeline, and
	•	Cases where the seed is explicitly documented and does not conflict with the global configuration.
The default assumption is: one global seed, configured once, controlling all substantive simulations.

	4.	Deterministic failure, no silent recovery
In core analytical routines (DGPs, OLS/HC estimators, simulation loops, aggregation):
	•	Do not use tryCatch, try, or similar constructs to silently continue after errors.
	•	If a simulation produces NA, NaN, or Inf in any primary metric, the code must fail deterministically with an informative error.
	•	Do not silently skip failed iterations, impute invalid values, or downplay numerical problems. Any such failure indicates a bug, numerical instability, or design flaw that must be addressed explicitly.

⸻

7. Documentation Style and Content

When modifying README.md, INDEX.md, or inline comments, the agent should:
	•	Use concise, technical descriptions.
	•	Explain what is implemented and under which assumptions, rather than teaching concepts from first principles.
	•	Frame justifications in reviewer-oriented language, for example:
	•	“This notebook implements the null calibration of the inferential score S_{\mathrm{Inf}} under homoskedastic linear regression to characterize its reference distribution.”
	•	“The Reliability Score S_{\mathrm{Rel}} applies an HC2-based finite-sample correction term 2/(3\sqrt{N}) to the raw ratio of standard errors and is calibrated against coverage loss under controlled heteroskedasticity.”

The agent must avoid:
	•	Colloquial expressions.
	•	Direct second-person address (“you can see that…”, “we show you…”).
	•	Pedagogical digressions that are not directly relevant to the methodological argument.

⸻

8. Scope of Autonomy

Unless otherwise specified in a task, the agent is allowed to:
	•	Edit existing notebooks and R files to improve clarity, modularity, and consistency.
	•	Update README.md, INDEX.md, and CHANGELOG.md only when there are real structural or methodological changes.
	•	Generate or update stable result artefacts in results/ that correspond directly to the main analytical pipeline.

Cross-file consistency

When modifying any core component, the agent must treat the codebase as a single coherent system, not as isolated files. In particular, any change to:
	•	Function interfaces (arguments, return values).
	•	DGPs or simulation settings.
	•	Metric definitions (e.g. any of sr_inf, sr_inf_adj, sr_ratio, sr_ratio_adj).
	•	Workflow assumptions (paths, grids, HC estimator choice).

must be accompanied by:
	1.	A search for all dependent usages across:
	•	R/ scripts
	•	notebooks/
	•	Documentation (README.md, INDEX.md)
	2.	Consistent updates to these usages.
	3.	A corresponding entry in CHANGELOG.md when behaviour changes.

The agent must not:
	•	Introduce new top-level directories or documentation formats without explicit instruction.
	•	Remove or rename core files (README.md, agent.md, key notebooks) unilaterally.
	•	Change definitions of core metrics without synchronizing all dependent code and documentation.

⸻

9. Project Status

The following status flags constrain what the agent may modify:
	•	Part 0 (Validation) – LOCKED
	•	Files: 00_HC_estimators_validation.Rmd, R/10_dgp_and_fits.R
	•	Status: Numerical equivalence of the matrix-based OLS + HC implementation to lm() + vcovHC() is established.
	•	Agent may: Fix trivial typos in comments.
	•	Agent may not: Change implementations or add new validation logic without explicit instruction.
	•	Part 1 (Null Calibration) – LOCKED
	•	Files: 01_null_calibration.Rmd, R/30_null_calibration.R, relevant entries in R/20_metrics.R.
	•	Status: HC2 is selected as the reference HC estimator; Q_{0.95}(S_{\mathrm{Inf}}) obeys an N^{-1/2} scaling; the effective constant is \approx 1.64 and aligned with z_{0.95} \approx 1.645.
	•	Agent may: Improve minor wording or formatting in narrative text.
	•	Agent may not: Alter the calibration logic, the choice of HC2, or the scaling law without explicit override.
	•	Part 2 (Heteroskedastic Validation and Lookup) – IN PROGRESS
	•	Files: e.g. 02_HC2_validation.Rmd, R/40_hetero_sims.R, R/50_invariance_and_lookup.R.
	•	Agent may: Refactor, extend, and finalize these components, subject to the constraints in this document.

⸻

10. Code Evolution Policy

No backward compatibility layer
	•	The codebase must not accumulate deprecated aliases, wrapper functions, or “legacy” modes.
	•	When refactoring:
	•	Update the canonical function(s) in-place.
	•	Update all call sites.
	•	Remove obsolete functions and variables rather than marking them as deprecated.
	•	If a metric or function definition changes:
	•	Delete the old definition rather than renaming it with _old or _legacy.
	•	Align all notebooks and documentation with the new definition.
	•	Record the change and its implications in CHANGELOG.md.

The guiding principle is that the repository should always present a single, current, coherent implementation of the methodology, suitable for scrutiny by methodological reviewers, without internal legacy branches or ambiguity about which version is authoritative.

⸻
